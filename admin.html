<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoteChain | Admin Console</title>
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: {
                            50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 900: '#312e81',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
    </style>
</head>
<body class="bg-gray-50 text-slate-800 dark:bg-slate-900 dark:text-slate-200 transition-colors duration-300 min-h-screen flex flex-col">

    <!-- NAVBAR -->
    <nav class="sticky top-0 z-50 backdrop-blur-lg bg-white/80 dark:bg-slate-900/80 border-b border-gray-200 dark:border-slate-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <!-- Logo -->
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 bg-slate-900 dark:bg-white rounded-lg flex items-center justify-center text-white dark:text-slate-900 shadow-lg shadow-slate-500/20">
                        <span class="material-symbols-rounded text-xl">admin_panel_settings</span>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold tracking-tight text-slate-900 dark:text-white leading-none">VoteChain Admin</h1>
                        <p class="text-xs text-slate-500 dark:text-slate-400 font-medium">Control Center</p>
                    </div>
                </div>

                <!-- Right Actions -->
                <div class="flex items-center gap-4">
                    <!-- Contract Info -->
                    <div class="hidden md:flex flex-col items-end mr-2">
                        <span class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Active Contract</span>
                        <div class="flex items-center gap-2">
                             <span id="shortAddress" class="font-mono text-xs text-brand-600 dark:text-brand-400 cursor-pointer hover:underline bg-brand-50 dark:bg-brand-900/20 px-2 py-0.5 rounded" onclick="promptNewContract()">
                                0x...
                            </span>
                            <button onclick="resetContractAddress()" title="Reset to Default" class="text-slate-400 hover:text-red-500 transition-colors">
                                <span class="material-symbols-rounded text-sm">restart_alt</span>
                            </button>
                        </div>
                    </div>

                    <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400 transition-colors">
                        <span id="theme-icon" class="material-symbols-rounded text-xl">light_mode</span>
                    </button>

                    <button id="connectBtn" onclick="connectWallet()" class="flex items-center gap-2 bg-slate-900 hover:bg-slate-800 dark:bg-white dark:hover:bg-gray-200 dark:text-slate-900 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all shadow-lg shadow-slate-500/20">
                        <span class="material-symbols-rounded text-lg">account_balance_wallet</span>
                        <span id="btn-text">Connect</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- LEFT COLUMN: CORE ACTIONS -->
        <div class="lg:col-span-2 space-y-6">
            
            <!-- 1. CANDIDATE MANAGEMENT -->
            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-gray-200 dark:border-slate-700 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-100 dark:border-slate-700 flex justify-between items-center bg-gray-50/50 dark:bg-slate-800/50">
                    <h2 class="text-sm font-bold text-slate-900 dark:text-white uppercase tracking-wide flex items-center gap-2">
                        <span class="material-symbols-rounded text-brand-500">person_add</span> Manage Ballot
                    </h2>
                </div>
                
                <div class="p-6">
                    <div class="flex gap-3 mb-6">
                        <div class="relative flex-1">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="material-symbols-rounded text-slate-400">badge</span>
                            </div>
                            <input type="text" id="candidateName" placeholder="Candidate Full Name" 
                                   class="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none transition-all placeholder-slate-400">
                        </div>
                        <button onclick="addCandidate()" id="btnAddCandidate" 
                                class="bg-brand-600 hover:bg-brand-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-brand-500/20 transition-all active:scale-95 flex items-center gap-2">
                            <span>Add</span>
                        </button>
                    </div>

                    <!-- Candidate List -->
                    <div class="bg-gray-50 dark:bg-slate-900/50 rounded-xl border border-gray-100 dark:border-slate-700 overflow-hidden">
                        <div class="px-4 py-2 border-b border-gray-100 dark:border-slate-700 text-xs font-bold text-slate-400 uppercase tracking-wider">
                            Current Candidates
                        </div>
                        <ul id="candidateList" class="divide-y divide-gray-100 dark:divide-slate-700">
                            <li class="p-4 text-sm text-slate-400 italic text-center">Loading candidates...</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- 2. VOTER REGISTRY -->
            <div id="voterRegistryPanel" class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-gray-200 dark:border-slate-700 overflow-hidden relative group">
                
                <!-- Lock Overlay -->
                <div id="registryLockOverlay" class="hidden absolute inset-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm z-10 flex-col items-center justify-center text-center p-6 fade-in">
                    <div class="bg-white dark:bg-slate-800 p-3 rounded-full shadow-lg mb-3 border border-gray-100 dark:border-slate-600">
                        <span class="material-symbols-rounded text-3xl text-amber-500">lock</span>
                    </div>
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white">Registry Locked</h3>
                    <p class="text-sm text-slate-500 dark:text-slate-400 max-w-xs mt-1">
                        New voters cannot be added while an election is active. <br>End the election to modify the roll.
                    </p>
                </div>

                <div class="px-6 py-4 border-b border-gray-100 dark:border-slate-700 flex justify-between items-center bg-gray-50/50 dark:bg-slate-800/50">
                    <h2 class="text-sm font-bold text-slate-900 dark:text-white uppercase tracking-wide flex items-center gap-2">
                        <span class="material-symbols-rounded text-green-500">how_to_reg</span> Voter Registration
                    </h2>
                </div>

                <div class="p-6 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1 ml-1">Aadhaar Number</label>
                            <input type="text" id="voterAadhaar" placeholder="12 Digit ID" 
                                   class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition-all">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1 ml-1">Full Name</label>
                            <input type="text" id="voterName" placeholder="Voter Name" 
                                   class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition-all">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1 ml-1">Constituency</label>
                        <input type="text" id="voterConst" placeholder="e.g., Mumbai South" 
                               class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition-all">
                    </div>

                    
                    <button onclick="addVoterToDB()" id="btnAddVoter" 
                            class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold shadow-lg shadow-green-500/20 transition-all active:scale-95 flex justify-center items-center gap-2 mt-2">
                        <span class="material-symbols-rounded">add_task</span> Register Eligible Voter
                    </button>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: OVERVIEW -->
        <div class="space-y-6">
            
            <!-- SYSTEM HEALTH MONITORING -->
            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-gray-200 dark:border-slate-700 p-6">
                <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <span class="material-symbols-rounded text-green-500">health_and_safety</span> System Health
                </h2>
                
                <div class="space-y-3">
                    <!-- Backend API Status -->
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-slate-700/30 rounded-xl border border-gray-100 dark:border-slate-600">
                        <div class="flex items-center gap-3">
                            <div id="backendStatusIndicator" class="w-2 h-2 rounded-full bg-slate-300 animate-pulse"></div>
                            <span class="text-sm text-slate-600 dark:text-slate-300">Backend API</span>
                        </div>
                        <span id="backendStatus" class="text-xs font-bold text-slate-400">Checking...</span>
                    </div>

                    <!-- Blockchain Connection -->
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-slate-700/30 rounded-xl border border-gray-100 dark:border-slate-600">
                        <div class="flex items-center gap-3">
                            <div id="blockchainStatusIndicator" class="w-2 h-2 rounded-full bg-slate-300 animate-pulse"></div>
                            <span class="text-sm text-slate-600 dark:text-slate-300">Blockchain RPC</span>
                        </div>
                        <span id="blockchainStatus" class="text-xs font-bold text-slate-400">Checking...</span>
                    </div>

                    <!-- Database Connection -->
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-slate-700/30 rounded-xl border border-gray-100 dark:border-slate-600">
                        <div class="flex items-center gap-3">
                            <div id="databaseStatusIndicator" class="w-2 h-2 rounded-full bg-slate-300 animate-pulse"></div>
                            <span class="text-sm text-slate-600 dark:text-slate-300">Database</span>
                        </div>
                        <span id="databaseStatus" class="text-xs font-bold text-slate-400">Checking...</span>
                    </div>

                    <!-- Kiosk Connection -->
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-slate-700/30 rounded-xl border border-gray-100 dark:border-slate-600">
                        <div class="flex items-center gap-3">
                            <div id="kioskStatusIndicator" class="w-2 h-2 rounded-full bg-slate-300 animate-pulse"></div>
                            <span class="text-sm text-slate-600 dark:text-slate-300">Kiosk Terminal</span>
                        </div>
                        <span id="kioskStatus" class="text-xs font-bold text-slate-400">Checking...</span>
                    </div>
                </div>
            </div>

            <!-- LIVE STATUS CARD -->
            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-gray-200 dark:border-slate-700 p-6">
                <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-6">Election Overview</h2>
                
                <div class="space-y-5">
                    <!-- Status Badge -->
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-slate-700/30 rounded-xl border border-gray-100 dark:border-slate-600">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-white dark:bg-slate-600 rounded-lg text-slate-500 shadow-sm">
                                <span class="material-symbols-rounded text-lg">monitor_heart</span>
                            </div>
                            <span class="font-medium text-sm text-slate-600 dark:text-slate-300">Status</span>
                        </div>
                        <span id="statusBadge" class="px-3 py-1 rounded-full bg-slate-200 text-slate-600 text-xs font-bold">Connecting...</span>
                    </div>

                    

                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-100 dark:border-blue-800/30">
                            <p class="text-xs font-medium text-blue-600 dark:text-blue-400 uppercase">Votes</p>
                            <h3 id="totalVotes" class="text-2xl font-bold text-slate-900 dark:text-white mt-1">--</h3>
                            <p id="voteDelta" class="text-[10px] text-green-600 dark:text-green-400 mt-1 font-medium"></p>
                        </div>
                        <div class="p-4 bg-purple-50 dark:bg-purple-900/20 rounded-xl border border-purple-100 dark:border-purple-800/30">
                            <p class="text-xs font-medium text-purple-600 dark:text-purple-400 uppercase">Candidates</p>
                            <h3 id="totalCandidates" class="text-2xl font-bold text-slate-900 dark:text-white mt-1">--</h3>
                        </div>
                    </div>

                    <!-- Turnout Metrics -->
                    <div class="p-4 bg-emerald-50 dark:bg-emerald-900/20 rounded-xl border border-emerald-100 dark:border-emerald-800/30">
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-xs font-medium text-emerald-600 dark:text-emerald-400 uppercase">Voter Turnout</p>
                            <span id="turnoutPercent" class="text-sm font-bold text-emerald-700 dark:text-emerald-300">--%</span>
                        </div>
                        <div class="w-full bg-emerald-200 dark:bg-emerald-900/40 rounded-full h-2">
                            <div id="turnoutBar" class="bg-emerald-600 dark:bg-emerald-500 h-2 rounded-full transition-all duration-500 turnout-bar-width"></div>
                        </div>
                        <p id="turnoutText" class="text-[10px] text-slate-500 dark:text-slate-400 mt-1"></p>
                    </div>
                </div>
            </div>

            <!-- LIFECYCLE ACTIONS -->
            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-gray-200 dark:border-slate-700 p-6">
                <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Election Controls</h2>
                
                <!-- Start Election -->
                <div class="mb-6">
                    <button onclick="startElection()" id="btnStartElection" class="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold transition-all flex items-center justify-center gap-2 shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">
                        <span class="material-symbols-rounded">play_circle</span> Start Election
                    </button>
                    <p class="text-[10px] text-slate-400 mt-2 text-center">Begin voting. Requires at least 1 candidate.</p>
                </div>

                <!-- End Election -->
                <div class="mb-6 pt-6 border-t border-gray-100 dark:border-slate-700">
                    <button onclick="endElection()" id="btnEndElection" class="w-full bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/30 text-red-600 dark:text-red-400 border border-red-200 dark:border-red-800/50 py-4 rounded-xl font-bold transition-all flex items-center justify-center gap-2 shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">
                        <span class="material-symbols-rounded">stop_circle</span> End Election
                    </button>
                    <p class="text-[10px] text-slate-400 mt-2 text-center">Irreversible. Finalizes the blockchain tally.</p>
                </div>

                <!-- New Election -->
                <div class="pt-6 border-t border-gray-100 dark:border-slate-700">
                    <button onclick="deployNewElection()" id="btnDeployNew" class="w-full py-2 text-slate-500 hover:text-brand-600 dark:hover:text-brand-400 text-sm font-medium transition-colors flex items-center justify-center gap-2">
                        <span class="material-symbols-rounded">add_circle</span> Deploy New Election
                    </button>
                </div>
            </div>

        </div>

    </main>

    <!-- TOAST CONTAINER -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-50 flex flex-col gap-2 pointer-events-none"></div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        // ============================================================
        // SERVICE DISCOVERY CONFIGURATION
        // ============================================================
        // Update these with your Supabase project details
        const CONFIG_SUPABASE_URL = "https://tmtcnjlwetkwslgirpzs.supabase.co";
        const CONFIG_SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtdGNuamx3ZXRrd3NsZ2lycHpzIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MjUxMDU1OSwiZXhwIjoyMDc4MDg2NTU5fQ.Z29FfApBXiKSb7d5f2HSbUghgtliXHaAE4dLs2mDerk";
        
        // Backend URL - will be dynamically discovered
        let BACKEND_URL = "http://127.0.0.1:3000"; // Fallback for local development
        
        // Track discovery state
        let serviceDiscovered = false;
        
        // ============================================================
        // DYNAMIC BACKEND DISCOVERY
        // ============================================================
        async function testBackendURL(url, timeout = 2000) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                const response = await fetch(`${url}/api/health`, {
                    method: 'GET',
                    signal: controller.signal,
                    mode: 'cors',
                    cache: 'no-cache'
                });
                clearTimeout(timeoutId);
                return response.ok;
            } catch (e) {
                return false;
            }
        }

        async function testTunnelViaProxy(tunnelURL) {
            // Try using a public CORS proxy for DNS-resistant fallback
            try {
                const corsProxy = 'https://api.allorigins.win/get?url=';
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000);
                
                const proxyURL = corsProxy + encodeURIComponent(tunnelURL + '/api/health');
                const response = await fetch(proxyURL, {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    return data.status === 200 || data.contents.includes('ok');
                }
                return false;
            } catch (e) {
                console.log('‚ö†Ô∏è Proxy fallback failed:', e.message);
                return false;
            }
        }
        
        async function discoverBackendURL() {
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                console.log('üîß Running locally - using localhost backend');
                serviceDiscovered = true;
                return BACKEND_URL;
            }
            
            console.log('üîÑ Discovering backend URL...');
            
            let tunnelURL = null;
            try {
                const response = await fetch(
                    `${CONFIG_SUPABASE_URL}/rest/v1/system_config?key=eq.backend_url&select=value`,
                    {
                        headers: {
                            'apikey': CONFIG_SUPABASE_KEY,
                            'Authorization': `Bearer ${CONFIG_SUPABASE_KEY}`
                        }
                    }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0 && data[0].value && data[0].value !== 'https://waiting-for-tunnel.com') {
                        tunnelURL = data[0].value;
                        console.log('‚úÖ Cloudflare Tunnel URL discovered:', tunnelURL);
                        if (data[0].updated_at) {
                            console.log('   Last updated:', data[0].updated_at);
                        }
                    }
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è Could not fetch tunnel URL:', e.message);
            }
            
            if (window.location.hostname !== 'cainebenoy.github.io') {
                console.log('üîç Scanning local network...');
                const localIPs = ['http://192.168.1.100:3000', 'http://192.168.1.1:3000', 'http://192.168.0.100:3000', 'http://10.0.0.100:3000', 'http://raspberrypi.local:3000'];
                for (const url of localIPs) {
                    if (await testBackendURL(url)) {
                        console.log('‚úÖ Found local IP:', url);
                        BACKEND_URL = url;
                        serviceDiscovered = true;
                        return BACKEND_URL;
                    }
                }
            }

            // Tunnel DNS resolution failed - try proxy-based approach
            if (tunnelURL) {
                console.log('‚ö†Ô∏è Direct tunnel access failed - attempting via CORS proxy...');
                if (await testTunnelViaProxy(tunnelURL)) {
                    console.log('‚úÖ Tunnel accessible via proxy');
                    BACKEND_URL = tunnelURL;
                    serviceDiscovered = true;
                    return BACKEND_URL;
                }
            }
            
            if (tunnelURL) {
                console.log('‚ö†Ô∏è DNS resolution failing - using tunnel URL anyway (will retry with fallback)');
                BACKEND_URL = tunnelURL;
                serviceDiscovered = true;
                return BACKEND_URL;
            }
            
            throw new Error('Could not discover backend');
        }
        
        // --- FETCH WITH PROXY FALLBACK ---
        async function fetchWithFallback(url, options = {}) {
            // Try direct fetch first
            try {
                const response = await fetch(url, { ...options, timeout: 3000 });
                if (response.ok) return response;
            } catch (e) {
                console.log('‚ö†Ô∏è Direct fetch failed for:', url.substring(0, 50) + '...');
            }
            
            // Fall back to CORS proxy for DNS failures
            try {
                const corsProxy = 'https://api.allorigins.win/get?url=';
                const proxyURL = corsProxy + encodeURIComponent(url);
                const response = await fetch(proxyURL, { timeout: 5000 });
                if (response.ok) {
                    const data = await response.json();
                    // Return a response-like object with the proxy data
                    return {
                        ok: true,
                        status: 200,
                        json: async () => JSON.parse(data.contents)
                    };
                }
            } catch (e) {
                console.log('‚ö†Ô∏è Proxy fallback also failed');
            }
            
            throw new Error('All fetch attempts failed');
        }
        
        // ============================================================
        // CONFIGURATION
        // ============================================================
        
        // DEFAULT CONTRACT ADDRESS (Sepolia)
        const DEFAULT_CONTRACT = "0x62f589eED2fEfEe77690FF83542EbAcc4d8670CA";
        
        // Contract address will be fetched from backend on load
        let contractAddress = DEFAULT_CONTRACT;
        
        // Fetch active contract from backend on page load
        async function loadActiveContract() {
            try {
                const res = await fetch(`${BACKEND_URL}/api/config`);
                const data = await res.json();
                if (data.contractAddress) {
                    contractAddress = data.contractAddress;
                    updateAddressDisplay();
                    console.log('‚úÖ Loaded contract from backend:', contractAddress);
                }
            } catch (e) {
                console.error('Failed to load contract from backend:', e);
                // Fall back to localStorage or default
                contractAddress = localStorage.getItem("votechain_contract") || DEFAULT_CONTRACT;
                updateAddressDisplay();
            }
        }
        
        // Load contract address immediately
        loadActiveContract();

        // ABI
        const contractABI = [ 
            "function admin() view returns (address)",
            "function addCandidate(string _name)",
            "function startElection()",
            "function endElection()",
            "function electionActive() view returns (bool)",
            "function totalCandidates() view returns (uint)",
            "function totalVotes() view returns (uint)",
            "function getAllCandidates() view returns (tuple(uint id, string name, uint voteCount)[])"
        ];

        let provider, signer, contract;
        let lastVoteCount = 0;
        let totalRegisteredVoters = 0;

        // --- SYSTEM HEALTH MONITORING ---
        async function checkSystemHealth() {
            // Check Backend API
            try {
                const res = await fetch(`${BACKEND_URL}/api/health`, { signal: AbortSignal.timeout(3000) });
                if (res.ok) {
                    document.getElementById('backendStatusIndicator').className = 'w-2 h-2 rounded-full bg-green-500';
                    document.getElementById('backendStatus').textContent = 'Online';
                    document.getElementById('backendStatus').className = 'text-xs font-bold text-green-600 dark:text-green-400';
                } else {
                    throw new Error('API Error');
                }
            } catch (e) {
                document.getElementById('backendStatusIndicator').className = 'w-2 h-2 rounded-full bg-red-500';
                document.getElementById('backendStatus').textContent = 'Offline';
                document.getElementById('backendStatus').className = 'text-xs font-bold text-red-600 dark:text-red-400';
            }

            // Check Database via Metrics
            try {
                const res = await fetch(`${BACKEND_URL}/api/metrics`, { signal: AbortSignal.timeout(3000) });
                const data = await res.json();
                if (data.status === 'success') {
                    document.getElementById('databaseStatusIndicator').className = 'w-2 h-2 rounded-full bg-green-500';
                    document.getElementById('databaseStatus').textContent = 'Connected';
                    document.getElementById('databaseStatus').className = 'text-xs font-bold text-green-600 dark:text-green-400';
                    
                    // Update turnout metrics
                    totalRegisteredVoters = data.data.votersMarkedVoted || 0;
                    updateTurnoutMetrics();
                } else {
                    throw new Error('DB Error');
                }
            } catch (e) {
                document.getElementById('databaseStatusIndicator').className = 'w-2 h-2 rounded-full bg-red-500';
                document.getElementById('databaseStatus').textContent = 'Error';
                document.getElementById('databaseStatus').className = 'text-xs font-bold text-red-600 dark:text-red-400';
            }

            // Check Blockchain (via contract if connected)
            if (contract) {
                try {
                    await contract.totalVotes();
                    document.getElementById('blockchainStatusIndicator').className = 'w-2 h-2 rounded-full bg-green-500';
                    document.getElementById('blockchainStatus').textContent = 'Synced';
                    document.getElementById('blockchainStatus').className = 'text-xs font-bold text-green-600 dark:text-green-400';
                } catch (e) {
                    document.getElementById('blockchainStatusIndicator').className = 'w-2 h-2 rounded-full bg-amber-500';
                    document.getElementById('blockchainStatus').textContent = 'Slow';
                    document.getElementById('blockchainStatus').className = 'text-xs font-bold text-amber-600 dark:text-amber-400';
                }
            }

            // Check Kiosk (via poll-commands endpoint)
            try {
                const res = await fetch(`${BACKEND_URL}/api/kiosk/poll-commands`, { signal: AbortSignal.timeout(2000) });
                if (res.ok) {
                    document.getElementById('kioskStatusIndicator').className = 'w-2 h-2 rounded-full bg-green-500';
                    document.getElementById('kioskStatus').textContent = 'Active';
                    document.getElementById('kioskStatus').className = 'text-xs font-bold text-green-600 dark:text-green-400';
                } else {
                    throw new Error('Kiosk Error');
                }
            } catch (e) {
                document.getElementById('kioskStatusIndicator').className = 'w-2 h-2 rounded-full bg-amber-500';
                document.getElementById('kioskStatus').textContent = 'Offline';
                document.getElementById('kioskStatus').className = 'text-xs font-bold text-amber-600 dark:text-amber-400';
            }
        }

        function updateTurnoutMetrics() {
            if (!contract) return;
            
            const totalVotes = parseInt(document.getElementById('totalVotes').textContent) || 0;
            
            // Calculate turnout percentage (votes / registered voters who voted)
            let turnoutPercent = 0;
            if (totalRegisteredVoters > 0) {
                turnoutPercent = Math.round((totalVotes / totalRegisteredVoters) * 100);
            }
            
            document.getElementById('turnoutPercent').textContent = turnoutPercent + '%';
            document.getElementById('turnoutBar').style.width = turnoutPercent + '%';
            document.getElementById('turnoutText').textContent = `${totalVotes} votes from ${totalRegisteredVoters} registered voters`;
        }

        async function fetchVoterCount() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/metrics`);
                const data = await response.json();
                if (data.totalRegisteredVoters !== undefined) {
                    totalRegisteredVoters = data.totalRegisteredVoters;
                    updateTurnoutMetrics();
                }
            } catch (error) {
                console.error('Failed to fetch voter count:', error);
            }
        }

        // --- THEME ---
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.toggle('dark');
            document.getElementById('theme-icon').innerText = isDark ? 'light_mode' : 'dark_mode';
        }

        // --- TOASTS ---
        function showToast(msg, type='info') {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            const colors = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-slate-800';
            el.className = `${colors} text-white px-6 py-4 rounded-xl shadow-xl flex items-center gap-3 transform transition-all duration-300 translate-y-10 opacity-0 pointer-events-auto`;
            el.innerHTML = `<span class="material-symbols-rounded">${type === 'success'?'check_circle':'info'}</span><span class="font-medium">${msg}</span>`;
            container.appendChild(el);
            setTimeout(() => el.classList.remove('translate-y-10', 'opacity-0'), 10);
            setTimeout(() => el.remove(), 3000);
        }

        // --- NETWORK SWITCHER HELPER ---
        async function switchToSepolia() {
            const SEP_CHAIN_ID = '0xaa36a7'; // 11155111 in hex
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: SEP_CHAIN_ID }],
                });
                return true;
            } catch (switchError) {
                // If chain missing, try adding it
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: SEP_CHAIN_ID,
                                chainName: 'Sepolia Test Network',
                                nativeCurrency: { name: 'Sepolia ETH', symbol: 'ETH', decimals: 18 },
                                rpcUrls: ['https://rpc.sepolia.org'],
                                blockExplorerUrls: ['https://sepolia.etherscan.io']
                            }],
                        });
                        return true;
                    } catch (addError) {
                        console.error(addError);
                        return false;
                    }
                }
                return false;
            }
        }

        // --- WALLET ---
        async function connectWallet() {
            if (!window.ethereum) return showToast("MetaMask not found!", 'error');
            try {
                // 1. Connect
                await window.ethereum.request({ method: "eth_requestAccounts" });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                
                // 2. Check Network & Switch if needed
                const network = await provider.getNetwork();
                if (network.chainId !== 11155111) {
                    showToast("Switching to Sepolia...", 'info');
                    const switched = await switchToSepolia();
                    if (!switched) return showToast("Please switch to Sepolia network", 'error');
                    // Re-init provider after switch
                    provider = new ethers.providers.Web3Provider(window.ethereum); 
                }

                signer = provider.getSigner();
                
                // 3. Init Contract
                try {
                    contract = new ethers.Contract(contractAddress, contractABI, signer);
                    // Test call to verify contract exists
                    await contract.electionActive();
                } catch (e) {
                    console.error("Contract Init Error:", e);
                    showToast("Invalid Contract Address! Please reset.", 'error');
                    return;
                }

                const address = await signer.getAddress();
                document.getElementById("btn-text").innerText = address.substring(0,6) + "...";
                
                showToast("Admin Wallet Connected", 'success');
                
                // Initial health check and turnout
                checkSystemHealth();
                await fetchVoterCount();
                updateTurnoutMetrics();
                
                // Start refresh intervals
                refreshData();
                setInterval(refreshData, 5000);
                setInterval(checkSystemHealth, 10000);
                setInterval(fetchVoterCount, 15000);

            } catch (e) { showToast(e.message, 'error'); }
        }

        // --- REFRESH ---
        async function refreshData() {
            if (!contract) return;
            try {
                // Status & Lock
                const active = await contract.electionActive();
                const statusBadge = document.getElementById("statusBadge");
                statusBadge.innerText = active ? "Active" : "Ended";
                statusBadge.className = `px-3 py-1 rounded-full text-xs font-bold ${active ? 'bg-green-100 text-green-700 dark:bg-green-900/20 dark:text-green-400' : 'bg-red-100 text-red-700 dark:bg-red-900/20 dark:text-red-400'}`;

                const lock = document.getElementById("registryLockOverlay");
                if (active) {
                    lock.classList.remove("hidden"); lock.classList.add("flex");
                    document.getElementById("btnEndElection").disabled = false;
                    document.getElementById("btnStartElection").disabled = true;
                    document.getElementById("btnAddCandidate").disabled = true;
                    document.getElementById("btnAddCandidate").classList.add("opacity-50", "cursor-not-allowed");
                } else {
                    lock.classList.add("hidden"); lock.classList.remove("flex");
                    document.getElementById("btnEndElection").disabled = true;
                    document.getElementById("btnStartElection").disabled = false;
                    document.getElementById("btnAddCandidate").disabled = false;
                    document.getElementById("btnAddCandidate").classList.remove("opacity-50", "cursor-not-allowed");
                }

                // Stats with delta tracking
                const v = await contract.totalVotes();
                const c = await contract.totalCandidates();
                const voteCount = v.toNumber ? v.toNumber() : Number(v);
                
                document.getElementById("totalVotes").innerText = voteCount;
                document.getElementById("totalCandidates").innerText = c.toString();
                
                // Show vote delta
                if (lastVoteCount > 0 && voteCount > lastVoteCount) {
                    const delta = voteCount - lastVoteCount;
                    document.getElementById('voteDelta').textContent = `+${delta} new ${delta === 1 ? 'vote' : 'votes'}`;
                    setTimeout(() => { document.getElementById('voteDelta').textContent = ''; }, 3000);
                }
                lastVoteCount = voteCount;
                
                // Update turnout
                updateTurnoutMetrics();

                // Candidates
                const list = await contract.getAllCandidates();
                const ul = document.getElementById("candidateList");
                ul.innerHTML = "";
                if (list.length === 0) {
                    ul.innerHTML = '<li class="p-4 text-sm text-slate-400 italic text-center">No candidates yet</li>';
                } else {
                    list.forEach(c => {
                        ul.innerHTML += `
                        <li class="flex justify-between items-center px-4 py-3 bg-white dark:bg-slate-800 rounded-lg border border-gray-100 dark:border-slate-700">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center text-xs font-bold text-slate-500 dark:text-slate-400">#${c.id}</div>
                                <span class="font-medium text-slate-900 dark:text-white">${c.name}</span>
                            </div>
                            <span class="text-sm font-bold text-brand-600 dark:text-brand-400">${c.voteCount} Votes</span>
                        </li>`;
                    });
                }

            } catch (e) { console.error(e); }
        }

        // --- ACTIONS ---
        async function addCandidate() {
            const name = document.getElementById("candidateName").value;
            if (!name) return showToast("Enter Name", 'error');
            try {
                const tx = await contract.addCandidate(name);
                showToast("Transaction Sent...", 'info');
                await tx.wait();
                showToast("Candidate Added!", 'success');
                document.getElementById("candidateName").value = "";
                refreshData();
            } catch (e) { showToast(e.message, 'error'); }
        }

        async function startElection() {
            if (!confirm("‚ö†Ô∏è Start the election?\n\nOnce started, you cannot add more candidates or voters until the election ends.")) return;
            try {
                const tx = await contract.startElection();
                showToast("Starting Election...", 'info');
                await tx.wait();
                showToast("Election Started! Voting is now open.", 'success');
                refreshData();
            } catch (e) { showToast(e.message, 'error'); }
        }

        async function endElection() {
            if (!confirm("‚ö†Ô∏è End the election permanently?")) return;
            try {
                const tx = await contract.endElection();
                showToast("Ending Election...", 'info');
                await tx.wait();
                showToast("Election Ended!", 'success');
                refreshData();
            } catch (e) { showToast(e.message, 'error'); }
        }

        // --- REMOTE ENROLLMENT LOGIC (Kiosk Integration) ---
        async function addVoterToDB() {
            const aadhaar = document.getElementById("voterAadhaar").value;
            const name = document.getElementById("voterName").value;
            const constituency = document.getElementById("voterConst").value;

            if(!aadhaar || !name) return showToast("Fill required fields", 'error');

            showToast("üîµ Activating Kiosk Scanner... Please wait.", 'info');
            const btn = document.getElementById("btnAddVoter");
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<span class="material-symbols-rounded animate-spin">sync</span> Waiting for Kiosk Scan...`;

            try {
                const payload = { aadhaar_id: aadhaar, name, constituency };
                const res = await fetch(`${BACKEND_URL}/api/admin/add-voter`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                if(data.status !== 'success') {
                    showToast(data.message, 'error');
                    resetBtn();
                    return;
                }

                showToast(`‚è≥ Target ID #${data.target_id} - Waiting for fingerprint scan...`, 'info');

                // 2. Poll for Completion
                const pollInterval = setInterval(async () => {
                    try {
                        const statusRes = await fetch(`${BACKEND_URL}/api/admin/enrollment-status`);
                        const statusData = await statusRes.json();
                        if(statusData.status === 'COMPLETED') {
                            clearInterval(pollInterval);
                            showToast("‚úÖ Voter Enrolled & Saved Successfully!", 'success');
                            document.getElementById("voterAadhaar").value = "";
                            document.getElementById("voterName").value = "";
                            document.getElementById("voterConst").value = "";
                            resetBtn();
                        } else if (statusData.status === 'FAILED') {
                            clearInterval(pollInterval);
                            const errorMsg = statusData.error_message || "Enrollment failed at Kiosk";
                            showToast(`‚ùå ${errorMsg}. Try again.`, 'error');
                            resetBtn();
                        } else if (statusData.status === 'IDLE' && !statusData.aadhaar_id) {
                            clearInterval(pollInterval);
                            showToast("‚è±Ô∏è Request timed out. Please try again.", 'error');
                            resetBtn();
                        }
                    } catch(e) {
                        console.error("Polling error:", e);
                    }
                }, 1000);

                setTimeout(() => {
                    clearInterval(pollInterval);
                    if(btn.disabled) {
                        showToast("‚è±Ô∏è Enrollment timed out. Please try again.", 'error');
                        resetBtn();
                    }
                }, 60000);

            } catch(e) { 
                showToast("Backend Connection Error: " + e.message, 'error'); 
                resetBtn();
            }

            function resetBtn() {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }
        // --- MULTIPLE ELECTION SUPPORT ---
        async function deployNewElection() {
            if(!confirm("‚ö†Ô∏è Deploy a new election contract?\n\nThis will:\n‚Ä¢ Deploy a fresh VotingV2 contract\n‚Ä¢ Reset ALL voters to 'has_voted = false'\n‚Ä¢ Cost gas fees (~0.001 ETH)\n‚Ä¢ Switch to the new contract\n\nExisting voter registry will be preserved.\n\nContinue?")) return;
            
            const btn = document.getElementById("btnDeployNew");
            btn.disabled = true;
            btn.innerHTML = '<span class="material-symbols-rounded animate-spin">progress_activity</span> Deploying...';
            
            try {
                showToast("Deploying new contract & resetting voters...", 'info');
                
                const res = await fetch(`${BACKEND_URL}/api/admin/deploy-contract`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await res.json();
                
                if(data.status === 'success') {
                    const newAddr = data.data.contractAddress;
                    const votersReset = data.data.votersReset;

                    showToast(`‚úÖ Contract deployed: ${newAddr.substring(0,10)}...`, 'success');
                    if(votersReset) {
                        showToast('‚úÖ Voter database reset successfully', 'success');
                    }

                    // Update the contract address in memory and display
                    contractAddress = newAddr;
                    updateAddressDisplay();

                    // Refresh backend config and dashboard data
                    try {
                        await loadActiveContract();
                    } catch (e) {
                        console.warn('Failed to reload backend config:', e);
                    }

                    // If admin wallet is connected, reinitialize the contract instance
                    try {
                        if (signer) {
                            contract = new ethers.Contract(contractAddress, contractABI, signer);
                            // Test call to ensure the new contract responds
                            await contract.electionActive();
                        }
                    } catch (e) {
                        console.warn('Reinit contract with signer failed:', e);
                        showToast('Contract deployed but your wallet may need to reconnect.', 'info');
                    }

                    // Refresh on-page data from contract
                    try { await refreshData(); } catch (e) { console.warn('refreshData failed:', e); }

                    showToast('‚úÖ Contract updated and dashboard refreshed', 'success');

                    // Reset button
                    btn.disabled = false;
                    btn.innerHTML = '<span class="material-symbols-rounded">add_circle</span> Deploy New Election';
                    
                    
                } else {
                    showToast(data.message || 'Deployment failed', 'error');
                    btn.disabled = false;
                    btn.innerHTML = '<span class="material-symbols-rounded">add_circle</span> Deploy New Election';
                }
                
            } catch(e) {
                console.error(e);
                showToast('Backend error: ' + e.message, 'error');
                btn.disabled = false;
                btn.innerHTML = '<span class="material-symbols-rounded">add_circle</span> Deploy New Election';
            }
        }

        function promptNewContract() {
            const newAddr = prompt("Enter new Election Contract Address:", contractAddress);
            if (newAddr && newAddr.startsWith("0x")) {
                localStorage.setItem("votechain_contract", newAddr);
                contractAddress = newAddr;
                updateAddressDisplay();
                window.location.reload();
            }
        }

        function resetContractAddress() {
            if(confirm("Reset to default contract?")) {
                localStorage.removeItem("votechain_contract");
                contractAddress = DEFAULT_CONTRACT;
                updateAddressDisplay();
                window.location.reload();
            }
        }

        function updateAddressDisplay() {
            document.getElementById("shortAddress").innerText = contractAddress.substring(0,6) + "..." + contractAddress.substring(38);
        }

        // ============================================================
        // INITIALIZATION WITH SERVICE DISCOVERY
        // ============================================================
        async function initApp() {
            console.log('üöÄ Initializing VoteChain Admin Console...');
            
            // Step 1: Discover backend URL
            showToast('üîç Discovering VoteChain backend...', 'info');
            const url = await discoverBackendURL();
            if (!url) {
                console.error('‚ùå Cannot proceed without backend URL');
                showToast('‚ùå Failed to connect. Please check console (F12) for details.', 'error');
                return;
            }
            
            showToast('‚úÖ Backend found! Loading data...', 'success');
            
            // Step 2: Load contract configuration from backend
            try {
                await loadActiveContract();
            } catch (e) {
                console.warn('‚ö†Ô∏è Could not load contract from backend:', e);
                showToast('‚ö†Ô∏è Could not load contract config', 'warning');
            }
            
            // Step 3: Check backend health
            try {
                await checkSystemHealth();
            } catch (e) {
                console.warn('‚ö†Ô∏è Backend health check failed:', e);
            }
            
            // Step 4: Load initial data
            try {
                await refreshData();
                showToast('‚úÖ Admin console ready!', 'success');
            } catch (e) {
                console.warn('‚ö†Ô∏è Could not load initial data:', e);
                showToast('‚ö†Ô∏è Some data could not be loaded', 'warning');
            }
            
            console.log('‚úÖ Admin console initialized');
        }

        // Start initialization when page loads
        document.addEventListener('DOMContentLoaded', initApp);

        
    </script>
</body>
</html>
