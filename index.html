<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Voting dApp</title>
    <style>
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; margin: 2em; background-color: #f7f7f7; color: #333;}
        .container { max-width: 900px; margin: auto; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 20px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        h1, h2 { color: #1a1a1a; }
        input, select { width: calc(100% - 24px); padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; cursor: pointer; border-radius: 4px; border: none; color: white; font-weight: bold; transition: background-color 0.2s; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        .btn-primary { background-color: #007bff; }
        .btn-secondary { background-color: #6c757d; }
        .btn-danger { background-color: #dc3545; }
        #status { font-weight: bold; }
        #winner-info { padding: 10px; background-color: #e0f0ff; border: 1px solid #b3d7ff; border-radius: 4px; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Advanced Voting dApp</h1>
        <div class="card">
            <p>Status: <span id="status">Not Connected</span> | Election Active: <span id="electionStatus">Unknown</span></p>
            <p>Admin: <span id="adminAddress">Unknown</span></p>
            <button id="connectButton" class="btn-primary">Connect to MetaMask</button>
        </div>

        <div class="grid">
            <div id="admin-panel" class="card" style="display:none;">
                <h2>Admin Panel</h2>
                <input type="text" id="candidateName" placeholder="Candidate Name">
                <button id="addCandidateButton" class="btn-primary">Add Candidate</button>
                <br><br>
                <input type="text" id="voterAddress" placeholder="Voter Address">
                <button id="authorizeVoterButton" class="btn-primary">Authorize Voter</button>
                <hr style="margin: 20px 0;">
                <button id="endElectionButton" class="btn-danger">End Election</button>
            </div>

            <div class="card">
                <h2>Voter Panel</h2>
                <select id="candidateSelect"></select>
                <button id="voteButton" class="btn-primary">Cast Vote</button>
            </div>
        </div>

        <div class="card">
            <h2>Election Results</h2>
            <button id="refreshCandidatesButton" class="btn-secondary">Refresh List</button>
            <div id="winner-info" style="display:none;">
                <h3>üèÜ Winner</h3>
                <p id="winner-details"></p>
            </div>
            <h3>Candidates</h3>
            <ul id="candidatesList"></ul>
        </div>
    </div>

    <script src="https://cdn.ethers.io/lib/ethers-5.7.2/dist/ethers.umd.js"></script>
    <script>
        // --- CONFIGURATION ---
        const contractAddress = "YOUR_CONTRACT_ADDRESS"; // <-- PASTE YOUR DEPLOYED CONTRACT ADDRESS HERE
        const contractABI = [ { "inputs": [], "stateMutability": "nonpayable", "type": "constructor" }, { "anonymous": false, "inputs": [ { "indexed": true, "internalType": "uint256", "name": "candidateId", "type": "uint256" }, { "indexed": false, "internalType": "string", "name": "name", "type": "string" } ], "name": "CandidateAdded", "type": "event" }, { "anonymous": false, "inputs": [ { "indexed": false, "internalType": "uint256", "name": "winnerCandidateId", "type": "uint256" }, { "indexed": false, "internalType": "string", "name": "winnerName", "type": "string" }, { "indexed": false, "internalType": "uint256", "name": "winningVoteCount", "type": "uint256" } ], "name": "ElectionEnded", "type": "event" }, { "anonymous": false, "inputs": [ { "indexed": true, "internalType": "address", "name": "voter", "type": "address" }, { "indexed": true, "internalType": "uint256", "name": "candidateId", "type": "uint256" } ], "name": "VoteCast", "type": "event" }, { "anonymous": false, "inputs": [ { "indexed": true, "internalType": "address", "name": "voter", "type": "address" } ], "name": "VoterAuthorized", "type": "event" }, { "inputs": [ { "internalType": "string", "name": "_name", "type": "string" } ], "name": "addCandidate", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "admin", "outputs": [ { "internalType": "address", "name": "", "type": "address" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "_voter", "type": "address" } ], "name": "authorizeVoter", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "name": "candidates", "outputs": [ { "internalType": "uint256", "name": "id", "type": "uint256" }, { "internalType": "string", "name": "name", "type": "string" }, { "internalType": "uint256", "name": "voteCount", "type": "uint256" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "electionEnded", "outputs": [ { "internalType": "bool", "name": "", "type": "bool" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "endElection", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "getAllCandidates", "outputs": [ { "components": [ { "internalType": "uint256", "name": "id", "type": "uint256" }, { "internalType": "string", "name": "name", "type": "string" }, { "internalType": "uint256", "name": "voteCount", "type": "uint256" } ], "internalType": "struct Voting.Candidate[]", "name": "", "type": "tuple[]" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "uint256", "name": "_candidateId", "type": "uint256" } ], "name": "getCandidate", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" }, { "internalType": "string", "name": "", "type": "string" }, { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "_voter", "type": "address" } ], "name": "getVoterInfo", "outputs": [ { "internalType": "bool", "name": "", "type": "bool" }, { "internalType": "bool", "name": "", "type": "bool" }, { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getWinner", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getWinnerDetails", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" }, { "internalType": "string", "name": "", "type": "string" }, { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "isElectionActive", "outputs": [ { "internalType": "bool", "name": "", "type": "bool" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "totalCandidates", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "totalVotes", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "uint256", "name": "_candidateId", "type": "uint256" } ], "name": "vote", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "", "type": "address" } ], "name": "voters", "outputs": [ { "internalType": "bool", "name": "isAuthorized", "type": "bool" }, { "internalType": "bool", "name": "hasVoted", "type": "bool" }, { "internalType": "uint256", "name": "votedCandidateId", "type": "uint256" } ], "stateMutability": "view", "type": "function" } ];

        // --- DOM Elements ---
        const statusEl = document.getElementById('status');
        const electionStatusEl = document.getElementById('electionStatus');
        const adminAddressEl = document.getElementById('adminAddress');
        const connectButton = document.getElementById('connectButton');
        const adminPanel = document.getElementById('admin-panel');
        const addCandidateButton = document.getElementById('addCandidateButton');
        const authorizeVoterButton = document.getElementById('authorizeVoterButton');
        const endElectionButton = document.getElementById('endElectionButton');
        const voteButton = document.getElementById('voteButton');
        const refreshCandidatesButton = document.getElementById('refreshCandidatesButton');
        const candidatesList = document.getElementById('candidatesList');
        const candidateNameInput = document.getElementById('candidateName');
        const voterAddressInput = document.getElementById('voterAddress');
        const candidateSelect = document.getElementById('candidateSelect');
        const winnerInfoDiv = document.getElementById('winner-info');
        const winnerDetailsP = document.getElementById('winner-details');

        let provider, signer, contract;

        const connectWallet = async () => {
            if (typeof window.ethereum === 'undefined') return alert('Please install MetaMask!');
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                contract = new ethers.Contract(contractAddress, contractABI, signer);
                
                const address = await signer.getAddress();
                statusEl.textContent = `Connected: ${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
                connectButton.textContent = "Connected";
                await updateUI();
            } catch (error) { console.error("User rejected connection.", error); }
        };
        
        const updateUI = async () => {
            if (!contract) return;
            await fetchElectionStatus();
            await fetchCandidates();
            await checkAdmin();
        };

        const checkAdmin = async () => {
            const contractAdmin = await contract.admin();
            const currentUser = await signer.getAddress();
            adminAddressEl.textContent = contractAdmin;
            if (currentUser.toLowerCase() === contractAdmin.toLowerCase()) {
                adminPanel.style.display = 'block';
            } else {
                adminPanel.style.display = 'none';
            }
        };

        const fetchElectionStatus = async () => {
            try {
                const isActive = await contract.isElectionActive();
                electionStatusEl.textContent = isActive ? "Active" : "Ended";
                if (!isActive) {
                    [addCandidateButton, authorizeVoterButton, endElectionButton, voteButton].forEach(btn => btn.disabled = true);
                    await fetchWinner();
                }
            } catch (error) { console.error("Could not fetch election status", error); }
        };

        const fetchCandidates = async () => {
            candidatesList.innerHTML = "<li>Loading...</li>";
            candidateSelect.innerHTML = "";
            try {
                const allCandidates = await contract.getAllCandidates();
                let html = "";
                allCandidates.forEach(candidate => {
                    html += `<li>ID: ${candidate.id} - ${candidate.name} - Votes: ${candidate.voteCount}</li>`;
                    const option = document.createElement('option');
                    option.value = candidate.id;
                    option.textContent = `${candidate.name} (ID: ${candidate.id})`;
                    candidateSelect.appendChild(option);
                });
                candidatesList.innerHTML = html || "<li>No candidates yet.</li>";
            } catch (error) { console.error("Could not fetch candidates.", error); }
        };

        const fetchWinner = async () => {
            try {
                const winnerDetails = await contract.getWinnerDetails();
                winnerDetailsP.textContent = `ID: ${winnerDetails[0]}, Name: ${winnerDetails[1]}, Votes: ${winnerDetails[2]}`;
                winnerInfoDiv.style.display = 'block';
            } catch (error) {
                winnerInfoDiv.style.display = 'none';
            }
        };

        const handleTransaction = async (button, txFunction) => {
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = "Mining...";
            try {
                const tx = await txFunction();
                await tx.wait();
                button.textContent = "Success!";
                setTimeout(() => {
                    button.textContent = originalText;
                    button.disabled = false;
                    updateUI();
                }, 2000);
            } catch (error) {
                console.error("Transaction failed:", error);
                const reason = error.reason || error?.data?.message || "Transaction failed.";
                alert(`Error: ${reason}`);
                button.textContent = originalText;
                button.disabled = false;
            }
        };

        connectButton.onclick = connectWallet;
        refreshCandidatesButton.onclick = updateUI;
        
        addCandidateButton.onclick = () => {
            const name = candidateNameInput.value;
            if (!name) return alert('Please enter a candidate name.');
            handleTransaction(addCandidateButton, () => contract.addCandidate(name));
            candidateNameInput.value = "";
        };

        authorizeVoterButton.onclick = () => {
            const address = voterAddressInput.value;
            if (!ethers.utils.isAddress(address)) return alert('Please enter a valid Ethereum address.');
            handleTransaction(authorizeVoterButton, () => contract.authorizeVoter(address));
            voterAddressInput.value = "";
        };

        endElectionButton.onclick = () => {
            if (confirm("Are you sure you want to end the election? This cannot be undone.")) {
                handleTransaction(endElectionButton, () => contract.endElection());
            }
        };

        voteButton.onclick = () => {
            const id = candidateSelect.value;
            if (!id) return alert('No candidate selected.');
            handleTransaction(voteButton, () => contract.vote(id));
        };

        if(window.ethereum) {
            window.ethereum.on('accountsChanged', connectWallet);
        }
    </script>
</body>
</html>